# Alternative Dockerfile with better error handling and optimization
# Use this if the main Dockerfile continues to fail

FROM python:3.12-slim

# Set pip configuration for better reliability
ENV PIP_DEFAULT_TIMEOUT=300 \
    PIP_RETRIES=5 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONUNBUFFERED=1

# Install system dependencies for PDF processing and OCR
RUN apt-get update && apt-get install -y \
    build-essential \
    tesseract-ocr \
    tesseract-ocr-eng \
    libtesseract-dev \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Create non-root user
RUN useradd --create-home --shell /bin/bash app \
    && mkdir -p /app \
    && chown -R app:app /app

USER app
WORKDIR /app

# Upgrade pip first
RUN pip install --user --upgrade pip setuptools wheel

# Copy requirements first for better caching
COPY --chown=app:app requirements.txt ./

# Install dependencies in groups to avoid timeouts
# Core FastAPI and async dependencies
RUN pip install --user \
    fastapi==0.104.1 \
    uvicorn[standard]==0.24.0 \
    python-dotenv==1.0.0

# Database dependencies
RUN pip install --user \
    sqlalchemy[asyncio]==2.0.23 \
    aiosqlite==0.19.0 \
    alembic==1.12.1

# HTTP and API dependencies
RUN pip install --user \
    httpx==0.25.2 \
    python-multipart==0.0.6

# LLM and language processing
RUN pip install --user \
    langextract==1.0.9 \
    langdetect==1.0.9

# PDF processing (potentially large)
RUN pip install --user \
    pymupdf>=1.24.0 \
    pytesseract==0.3.10 \
    pillow==10.1.0

# Utility dependencies
RUN pip install --user \
    cachetools==5.3.2 \
    tenacity==8.2.3 \
    prometheus-client==0.19.0

# spaCy (large, install separately)
RUN pip install --user spacy==3.7.2

# Download spaCy language model
RUN pip install --user \
    https://github.com/explosion/spacy-models/releases/download/en_core_web_sm-3.7.1/en_core_web_sm-3.7.1-py3-none-any.whl

# Copy application code
COPY --chown=app:app . .

EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Environment variables
ENV LOG_TO_FILE=false \
    ENV=prod \
    PATH="/home/app/.local/bin:$PATH"

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
